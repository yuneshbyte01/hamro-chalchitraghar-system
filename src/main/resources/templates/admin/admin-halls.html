<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hall Occupancy ‚Äì Hamro Chalchitraghar</title>

    <!-- ‚úÖ Bootstrap + Chart.js + WebSocket -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            border-radius: 12px;
        }
        .progress-bar {
            font-weight: 600;
        }
    </style>
</head>

<body class="p-4">
<div class="container">
    <h2 class="text-center mb-4">üè¢ Hall Occupancy Monitoring</h2>

    <!-- ‚úÖ Dynamic Hall Cards -->
    <div class="row" th:each="h : ${halls}">
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <h5 class="fw-bold" th:text="'Hall ' + ${h.hallNo} + ' ‚Äì ' + ${h.movie}"></h5>
                    <p class="text-muted" th:text="${#temporals.format(h.showTime, 'dd-MMM hh:mm a')}"></p>

                    <div>
                        <strong>Booked:</strong>
                        <span th:text="${h.bookedSeats}"></span> /
                        <span th:text="${h.totalSeats}"></span>
                    </div>

                    <!-- ‚úÖ Fixed Progress Bar Expression -->
                    <div class="progress my-3" style="height: 22px;">
                        <div class="progress-bar" role="progressbar"
                             th:style="'width:' + ${h.occupancyRate} + '%;background-color:' +
                             (${h.occupancyRate} >= 80 ? 'red' :
                             (${h.occupancyRate} >= 50 ? 'orange' : 'green'))"
                             th:text="${#numbers.formatDecimal(h.occupancyRate, 0, 1)} + '%'">
                        </div>
                    </div>

                    <!-- ‚úÖ Donut Chart -->
                    <canvas th:attr="id='chart-' + ${h.hallNo}" height="140"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="text-center mt-4">
        <a href="/admin/dashboard" class="btn btn-secondary px-4">‚¨Ö Back to Dashboard</a>
    </div>
</div>

<!-- ‚úÖ Chart Rendering + WebSocket Auto-Refresh -->
<script th:inline="javascript">
    /*<![CDATA[*/
    const halls = /*[[${halls}]]*/ [];

    halls.forEach(h => {
        const ctx = document.getElementById('chart-' + h.hallNo);
        if (!ctx) return;

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Booked', 'Available'],
                datasets: [{
                    data: [h.bookedSeats, h.totalSeats - h.bookedSeats],
                    backgroundColor: ['#dc3545', '#28a745'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true, position: 'bottom' },
                    tooltip: { enabled: true }
                },
                cutout: '70%'
            }
        });
    });

    // ‚úÖ Real-time WebSocket Seat Update
    const socket = new SockJS('/ws');
    const stomp = Stomp.over(socket);
    stomp.connect({}, () => {
        console.log("‚úÖ Connected to WebSocket for Hall Monitoring");
        stomp.subscribe('/topic/seat-updates', (message) => {
            console.log("üîÑ Seat update received:", message.body);
            location.reload();
        });
    });
    /*]]>*/
</script>

</body>
</html>
