<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Seat Selection â€“ Hamro Chalchitraghar</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body {
            background: #111;
            color: #fff;
            font-family: 'Segoe UI', sans-serif;
        }

        .screen {
            width: 70%;
            height: 50px;
            background: #fff;
            border-radius: 0 0 100px 100px / 0 0 30px 30px;
            text-align: center;
            line-height: 50px;
            color: #000;
            font-weight: bold;
            margin: 20px auto 40px;
        }

        .row-label {
            width: 35px;
            text-align: center;
            font-weight: 600;
            font-size: 1rem;
            color: #bbb;
        }

        .seat-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .seat {
            position: relative;
            cursor: pointer;
            border: none;
            background: transparent;
            transition: transform 0.2s ease;
        }

        .seat:hover {
            transform: scale(1.08);
        }

        .seat svg {
            width: 58px;
            height: 58px;
        }

        .front-row svg path { fill: #e91e63; }
        .back-row svg path { fill: #d32f2f; }
        .selected svg path { fill: #ff9800; }
        .booked svg path { fill: #616161; cursor: not-allowed; }

        .seat span {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -55%);
            font-size: 0.9rem;
            font-weight: 700;
            color: #fff;
            pointer-events: none;
        }

        .selected span {
            color: #000;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 30px;
        }

        .legend div {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #ccc;
        }

        .legend svg {
            width: 22px;
            height: 22px;
        }

        .btn-confirm {
            background-color: #ff6600;
            border: none;
        }

        .btn-confirm:hover {
            background-color: #e65c00;
        }
    </style>
</head>
<body class="p-4">
<div class="container text-center">
    <h2 class="fw-bold mb-4">ðŸŽŸ Choose Your Seats</h2>

    <div class="screen">SCREEN</div>

    <div th:if="${seats}">
        <div th:each="rowLabel : ${#lists.arrayList('A','B','C','D','E','F','G','H','I','J','K')}">
            <div class="seat-row">
                <div class="row-label" th:text="${rowLabel}"></div>

                <button th:each="seat : ${seats}"
                        th:if="${seat.seatNo != null and seat.seatNo.startsWith(rowLabel)}"
                        th:classappend="${seat.booked} ? 'booked' :
                            (#lists.contains(#lists.arrayList('A','B','C','D','E','F'), rowLabel) ? 'front-row' : 'back-row')"
                        class="seat"
                        th:data-seat="${seat.seatNo}"
                        th:title="'Seat ' + ${seat.seatNo}"
                        onclick="toggleSeat(this)">
                    <svg viewBox="0 0 24 24">
                        <path d="M7 13v-2h10v2h-1v5h3v2H5v-2h3v-5H7zm10-7v3H7V6a3 3 0 013-3h4a3 3 0 013 3z"/>
                    </svg>
                    <span th:text="${seat.seatNo != null ? #strings.substring(seat.seatNo, 1) : ''}"></span>
                </button>
            </div>
        </div>
    </div>

    <div class="legend mt-4">
        <div><svg><path fill="#e91e63" d="M7 13v-2h10v2h-1v5h3v2H5v-2h3v-5H7z"/></svg> Front Row</div>
        <div><svg><path fill="#d32f2f" d="M7 13v-2h10v2h-1v5h3v2H5v-2h3v-5H7z"/></svg> Back Row</div>
        <div><svg><path fill="#ff9800" d="M7 13v-2h10v2h-1v5h3v2H5v-2h3v-5H7z"/></svg> Selected</div>
        <div><svg><path fill="#616161" d="M7 13v-2h10v2h-1v5h3v2H5v-2h3v-5H7z"/></svg> Booked</div>
    </div>

    <form id="bookingForm" th:action="@{'/user/shows/' + ${show.id} + '/book'}"
          method="post" class="text-center mt-4">
        <input type="hidden" name="customerId" value="1"/>
        <input type="hidden" id="seatNumbers" name="seatNumbers"/>
        <button type="button" class="btn btn-confirm btn-lg text-white fw-semibold"
                th:onclick="'submitBooking(' + ${show.id} + ')'">Confirm Booking</button>
        <a href="/user/" class="btn btn-secondary ms-2">Back</a>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    let stompClient;
    const showId = /*[[${show.id}]]*/ 0;

    function connectSocket() {
        const socket = new SockJS('/ws-seat');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, () => {
            stompClient.subscribe(`/topic/seats/${showId}`, (msg) => {
                const update = JSON.parse(msg.body);
                updateSeatUI(update);
            });
        });
    }

    function updateSeatUI(update) {
        const btn = document.querySelector(`[data-seat="${update.seatNo}"]`);
        if (!btn) return;
        btn.classList.remove('front-row', 'back-row', 'selected', 'booked');
        if (update.status === 'BOOKED') btn.classList.add('booked');
        else btn.classList.add(update.rowLabel && ['A','B','C','D','E','F'].includes(update.rowLabel) ? 'front-row' : 'back-row');
    }

    function toggleSeat(btn) {
        if (btn.classList.contains('booked')) return;
        btn.classList.toggle('selected');
    }

    function submitBooking(showId) {
        const selected = [...document.querySelectorAll('.selected')].map(b => b.dataset.seat);
        if (selected.length === 0) {
            alert("Please select at least one seat.");
            return;
        }
        document.getElementById('seatNumbers').value = selected.join(',');
        document.getElementById('bookingForm').submit();
    }

    document.addEventListener("DOMContentLoaded", connectSocket);
</script>
</body>
</html>
